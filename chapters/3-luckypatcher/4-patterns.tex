\section{Patterns applied by LuckyPatcher} \label{section:luckypatcher-patterns}
%START TEXT INPUT
This is my real text! Rest might be copied or not be checked!
%START TEXT INPUT

In order to identify the single patterns, the information from the output of cracking \ref{luckyInapp} right, of the apps was matched with the changes in the code. the changes in the code were inspected on dex, smali and java level with the tools explained in Section~\ref{section:reengineering}. in case of LVL, from the information where in the package the change was done, conclusion to the original class from in the lvl could be done

diff for original app and modified app

example code taken from an app which was inspected, modification happens for all at the same spot/manner

dex == smali, smali better readable but dex to see how easy change
since the translation from java to dex does some optimizations/logik, dex and java do not express the same, but it is how it is in the decompiled code, java is also an abstraction of the actual code, sometimes java also a little confusing since changes happened in dex code and cannot be decompiled to java in a good manner, very messy, it is included for better understanding anyways since humanreadable
\newline
\newline
\textbf{Pattern N1} \newline
classes it attacks
LicenseValidator, responsible for decrypting and verifying the response from the licensing server

one Pattern

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={1-3},
  caption={Diff on Dex level for N1 pattern},
  label={lst:n1DiffDex}
]{data/n1.diff}

values are swapped

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={5-9},
  caption={Diff on Smali level for N1 pattern},
  label={lst:n1DiffSmali}
]{data/n1.diff}

switch case for input 0x01 (not licensed) and 0x02 (old license key) are swapped

\lstinputlisting[
  basicstyle=\footnotesize,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={11-15},
  language=diff,
  caption={Diff on Java level for N1 pattern},
  label={lst:n1DiffJava}
]{data/n1.diff}
old code when license code not licensed return in case not licensed with error
after patching when not licensed return as old license key
\newline
\newline
\textbf{Pattern N2}\newline
classes it attacks

LicenseValidator, responsible for decrypting and verifying the response from the licensing server

one Pattern

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={1-3},
  caption={Diff on Dex level for N2 pattern},
  label={lst:n2DiffDex}
]{data/n2.diff}

move-result is replaced by move const

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={5-7},
  caption={Diff on Smali level for N2 pattern},
  label={lst:n2DiffSmali}
]{data/n2.diff}

instead of moving the result from a function to v3, it is initiated with true/1

\lstinputlisting[
  basicstyle=\footnotesize,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={8-11},
  language=diff,
  caption={Diff on Java level for N2 pattern},
  label={lst:n2DiffJava}
]{data/n2.diff}

old code: signature was verified, if true it is continued
after patching the verification is treated as always true and so it is continued
\newline
\newline
\textbf{Pattern N3}\newline
classes it attacks
\newline
\newline
\textbf{Pattern N3i}\newline
inverse version of pattern N
\newline
\newline
\textbf{Pattern N4}\newline
classes it attacks
\newline
\newline
\textbf{Pattern N5}\newline
classes it attacks
\newline
\newline
\textbf{Pattern N6}\newline
classes it attacks
\newline
\newline
\textbf{Pattern N7}\newline
classes it attacks
\newline
\newline
\textbf{Amazon}\newline
also applies pattern N2

classes it attacks, inside zirconia logic
com/amazon/android/licensing/b
com/amazon/android/o/d

one pattern, used on both

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={1-3},
  caption={Diff on Dex level for Amazon patch},
  label={lst:amazonDiffDex}
]{data/amazon.diff}

if-eqz is repalces by if-ne

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={5-7},
  caption={Diff on Smali level for Amazon patch},
  label={lst:amazonDiffSmali}
]{data/amazon.diff}
in the original code variable v0 is compared for not equality with zero
after it is patched it is always compared with itself which returns always true and the condition is always called

\lstinputlisting[
  basicstyle=\footnotesize,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={9-11},
  language=diff,
  caption={Diff on Java level for Amazon patch},
  label={lst:amazonDiffJava}
]{data/amazon.diff}

in the original code the result from the server is tested whether it is "LICENSED"
after patching the response is always evalauted and the result is compared with itself which is always true

result
never the less what the check for "LICENSED" returns, the condition for "LICENSED" is always called
\newline
\newline
\textbf{Samsung Pattern N2}\newline
also applies pattern N2

classes it attacks, inside zirconia logic
com/samsung/zirconia/LicenseRetriever
com/samsung/zirconia/Zirconia

two patterns, first used on both, second used twice on zirconia

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={1-7},
  caption={Diff on Dex level for Samsung patch},
  label={lst:samsungDiffDex}
]{data/samsung.diff}

pattern 1
input for if-eq is modified
pattern 2
move-result is replaced by move const

\lstinputlisting[
  style=diff,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={9-15},
  caption={Diff on Smali level for Samsung patch},
  label={lst:samsungDiffSmali}
]{data/samsung.diff}
pattern1
in the original code checks whether to different variables are equal
after patching the check is done with the same variables and thus always returns true

pattern2
in the original code the result of a function is moved to v0 and returned
after patching true/1 is always moved to v0 and returned

\lstinputlisting[
  basicstyle=\footnotesize,
  breakatwhitespace=false,
  breaklines=true,
  captionpos=b,
  frame=single,
  linerange={17-23},
  language=diff,
  caption={Diff on Java level for Samsung patch},
  label={lst:samsungDiffJava}
]{data/samsung.diff}

pattern1
in the original code
after patching

pattern2
in the original code
after patching

result
com/samsung/zirconia/LicenseRetriever
always starts condition, even though input is not "12" as supposed to start
com/samsung/zirconia/Zirconia
pattern1
always returns true for checkLicenseFile and checkLicenseFilePhase2, does not check anything which is done normally
pattern2
always starts condition, even though input is not as supposed to start
com/samsung/zirconia/Zirconia
\newline
asd
\begin{table}[h]
\centering
\begin{tabular}{l|cccccccc}
                           & \multicolumn{8}{c}{Patterns}           \\
\multicolumn{1}{c|}{Modus} & N1 & N2 & N3 & N3i & N4 & N5 & N6 & N7 \\ \hline
Auto                       & X  & X  & X  &     & X  &    &    &    \\
Auto (Inversed)            & X  & X  &    & X   & X  &    &    &    \\
Extreme                    &    &    &    &     &    & X  & X  & X  \\
Auto+Extreme               & X  & X  & X  &     & X  & X  & X  & X  \\
Auto (Inversed)+Extreme    & X  & X  &    & X   & X  & X  & X  &
\end{tabular}
\caption{Overview of patterns applied by each modus}
\label{table:patterns}
\end{table}

ZUSAMMENFASSUNG WAS JETZT ALSO JEDER MODI MACHT!



%
when  not modified large bytecode sections are identical and patched automatically, else pattern search and overwriting original bytes and therby efecctively patching application



com.google.android.vending.licensing.LicenseValidator
method verify(...) -see- was macht sie?
switch method is altered
was wird getauscht?


ServerManagedPolicy/APKExpansionPolicy
allowAccess() -see- was amcht sie



\cite{munteanLicense}
%

classes it works on


\cite{samsungZirconia} 4. appendix



!!! kann man das excel sheet in die datein machen und nicht als appendix, da manche apps ihre ergebnisse nicht Ã¶ffentlich sehen wollen !!!
